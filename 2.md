Внедрение OpenTelemetry (OTel) в Spring Boot можно выполнить двумя основными способами: **автоматическим** (через Java Agent) и **программным** (через Starter).

Для Spring Boot приложений сейчас наиболее актуален и удобен вариант с использованием официального **OpenTelemetry Spring Boot Starter**. Он интегрируется с контекстом Spring и позволяет гибко настраивать экспорт данных.

---

## 1. Зависимости в `pom.xml`

Чтобы всё работало корректно и версии не конфликтовали, лучше всего использовать **BOM (Bill of Materials)**.

```xml
<dependencyManagement>
    <dependencies>
        <dependency>
            <groupId>io.opentelemetry</groupId>
            <artifactId>opentelemetry-bom</artifactId>
            <version>1.38.0</version> <type>pom</type>
            <scope>import</scope>
        </dependency>
    </dependencies>
</dependencyManagement>

<dependencies>
    <dependency>
        <groupId>io.opentelemetry.instrumentation</groupId>
        <artifactId>opentelemetry-spring-boot-starter</artifactId>
        <version>2.4.0-alpha</version> </dependency>

    <dependency>
        <groupId>io.opentelemetry</groupId>
        <artifactId>opentelemetry-exporter-otlp</artifactId>
    </dependency>

    <dependency>
        <groupId>io.opentelemetry.instrumentation</groupId>
        <artifactId>opentelemetry-logback-appender-1.0</artifactId>
        <version>2.4.0-alpha</version>
        <scope>runtime</scope>
    </dependency>
</dependencies>

```

---

## 2. Архитектура потока данных

Перед настройкой важно понимать, как данные покидают ваше приложение.

---

## 3. Настройка `application.yaml` (или `.properties`)

После добавления зависимостей OpenTelemetry начнет собирать базовые метрики и трейсы, но их нужно куда-то отправить. Чаще всего используется протокол **OTLP**.

```yaml
otel:
  service:
    name: my-spring-boot-service # Имя вашего микросервиса
  exporter:
    otlp:
      endpoint: http://localhost:4318 # Адрес OTel Collector или Jaeger
  traces:
    exporter: otlp
  metrics:
    exporter: otlp
  logs:
    exporter: otlp
  instrumentation:
    # Можно выборочно включать/выключать модули
    spring-web:
      enabled: true
    jdbc:
      enabled: true

```

---

## 4. Как это работает (Краткий чек-лист)

1. **Трейсинг:** Автоматически создает Span'ы для всех входящих HTTP-запросов (через RestTemplate или WebClient) и запросов к БД.
2. **Метрики:** Собирает стандартные метрики JVM (память, потоки) и Spring (запросы, ошибки).
3. **Логи:** Если вы добавили Logback Appender, OpenTelemetry будет добавлять `trace_id` и `span_id` в каждый лог, что критически важно для отладки.

---

## Альтернатива: Java Agent

Если вы не хотите менять код и `pom.xml`, можно использовать **Java Agent**. Это "черный ящик", который подключается при запуске JAR-файла:

1. Скачиваете `opentelemetry-javaagent.jar`.
2. Запускаете приложение:
`java -javaagent:path/to/opentelemetry-javaagent.jar -Dotel.service.name=my-app -jar app.jar`

**Когда что выбирать?**

* **Starter (через POM):** Если вам нужна глубокая интеграция с кодом, кастомные бины `OpenTelemetry` или если вы деплоитесь в среду, где сложно менять параметры запуска.
* **Agent:** Если нужно быстро внедрить мониторинг в кучу разных сервисов без пересборки кода.

Хотите, я помогу составить конфигурацию для конкретного бэкенда, например, для **Jaeger** или **Prometheus**?
