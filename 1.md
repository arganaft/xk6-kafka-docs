Для успешной работы WebSocket в Kubernetes (особенно если вы используете **Istio**, судя по наличию `VirtualService` и `DestinationRule`), ключевым моментом является поддержка **длительных соединений** и корректная обработка HTTP-заголовков `Upgrade`.

Ваше предположение верно: набор файлов зависит от того, используете ли вы Service Mesh (Istio) или стандартный Ingress-контроллер (например, Nginx).

---

## 1. kind: Service

Это базовый ресурс. Здесь не нужно специфических настроек для WebSocket, но важно правильно указать порты.

```yaml
apiVersion: v1
kind: Service
metadata:
  name: spring-websocket-service
spec:
  selector:
    app: spring-app
  ports:
    - protocol: TCP
      port: 80
      targetPort: 8080 # порт вашего Spring Boot приложения

```

---

## 2. Если вы используете Istio (VirtualService и DestinationRule)

Istio по умолчанию поддерживает WebSocket, но главная проблема — **таймауты**. По умолчанию Istio может обрывать соединение через 15 секунд.

### kind: VirtualService

Здесь нужно **отключить таймаут**, чтобы соединение не закрывалось при простое.

```yaml
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: spring-websocket-vs
spec:
  hosts:
    - "your-domain.com"
  gateways:
    - my-gateway
  http:
    - route:
        - destination:
            host: spring-websocket-service
      # КРИТИЧНО ДЛЯ WEBSOCKET:
      timeout: 0s # Отключает таймаут, позволяя соединению жить долго

```

### kind: DestinationRule

Нужен только если у вас **несколько реплик** приложения и вы используете протоколы поверх WebSocket (например, STOMP), требующие "липких сессий" (Sticky Sessions).

```yaml
apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: spring-websocket-dr
spec:
  host: spring-websocket-service
  trafficPolicy:
    loadBalancer:
      consistentHash:
        httpCookie:
          name: JSESSIONID
          ttl: 0s

```

---

## 3. Если вы НЕ используете Istio, а используете Nginx Ingress

Если вы используете обычный **Ingress**, то `VirtualService` и `DestinationRule` вам не нужны. Вам нужно прописать аннотации в `Ingress`.

### kind: Ingress

```yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: spring-websocket-ingress
  annotations:
    # Увеличиваем таймауты, чтобы Nginx не рвал соединение
    nginx.ingress.kubernetes.io/proxy-read-timeout: "3600"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "3600"
    # Для некоторых старых версий контроллеров может потребоваться:
    # nginx.org/websocket-services: "spring-websocket-service"
spec:
  rules:
  - host: your-domain.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: spring-websocket-service
            port:
              number: 80

```

---

### Резюме: что именно вам нужно?

1. **Если у вас Istio:** Нужны `Service` и `VirtualService` (обязательно с `timeout: 0s`). `DestinationRule` — только если нужно привязывать клиента к конкретному поду.
2. **Если у вас нет Istio (только Ingress-Nginx):** Нужны `Service` и `Ingress` с аннотациями таймаутов.

**Важный нюанс по Spring Boot:**
Убедитесь, что в вашем коде `WebSocketConfig` настроен `setAllowedOrigins("*")` (или указан конкретный домен), иначе браузер может заблокировать соединение из-за политики CORS при прохождении через балансировщик.

Хотите, я помогу составить полный манифест Deployment для вашего Java-приложения, чтобы убедиться, что переменные окружения и пробы готовности (liveness/readiness) настроены верно?
