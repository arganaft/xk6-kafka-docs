# Диагностика проблемы с MockDataGenerator

## Пошаговая диагностика

### 1. Проверьте, что бин вообще создаётся

Сначала убедитесь, что проблема именно в `@ConditionalOnProperty`. Добавьте в главный класс:

```java
@SpringBootApplication
@EnableScheduling
public class Application {

    public static void main(String[] args) {
        ConfigurableApplicationContext ctx = SpringApplication.run(Application.class, args);
        
        // Проверяем, есть ли бин
        System.out.println("=== Contains MockDataGenerator: " + 
            ctx.containsBean("mockDataGenerator"));
        
        // Проверяем значение property
        System.out.println("=== mock-data.enabled: " + 
            ctx.getEnvironment().getProperty("app.mock-data.enabled"));
        
        // Проверяем все бины
        String[] beans = ctx.getBeanDefinitionNames();
        for (String bean : beans) {
            if (bean.toLowerCase().contains("mock") || bean.toLowerCase().contains("trade")) {
                System.out.println("=== Found bean: " + bean);
            }
        }
    }
}
```

### 2. Наиболее вероятные причины

#### Причина №1: `application.yml` не читается (САМАЯ ЧАСТАЯ)

**Файл лежит не там, где нужно.** Должен быть строго:

```
src/
  main/
    resources/
      application.yml    ← именно здесь
```

Проверьте:
```java
// В main методе добавьте:
System.out.println("=== Active profiles: " + 
    Arrays.toString(ctx.getEnvironment().getActiveProfiles()));
System.out.println("=== app.mock-data.enabled = " + 
    ctx.getEnvironment().getProperty("app.mock-data.enabled"));
System.out.println("=== spring.application.name = " + 
    ctx.getEnvironment().getProperty("spring.application.name"));
```

Если `spring.application.name` тоже `null` — **файл не читается вообще**.

#### Причина №2: Формат YAML сломан (отступы!)

Ваш YAML может иметь проблемы с отступами. Перепишите с нуля:

```yaml
spring:
  application:
    name: trade-websocket-api
  threads:
    virtual:
      enabled: true

app:
  mock-data:
    enabled: true
    interval-ms: 1000
```

> ⚠️ **Используйте только пробелы, НЕ табы!** Каждый уровень — 2 пробела.

#### Причина №3: Есть другой файл, который перекрывает

Проверьте, нет ли:
- `application.properties` (он может перекрывать `.yml`)
- `application-default.yml`
- `application-local.yml`
- Переменных окружения `APP_MOCK_DATA_ENABLED=false`

```bash
# Поищите все конфиг-файлы
find . -name "application*" -type f
```

#### Причина №4: `TradeService` не создаётся → и `MockDataGenerator` не создаётся

Если `TradeService` не может быть создан (ошибка в его зависимостях), то и `MockDataGenerator` не будет создан. Проверьте логи на наличие ошибок.

### 3. Быстрый тест — уберите условие

Временно уберите `@ConditionalOnProperty` и проверьте:

```java
@Service
@Slf4j
@RequiredArgsConstructor
// @ConditionalOnProperty(name = "app.mock-data.enabled", havingValue = "true", matchIfMissing = false)
public class MockDataGenerator {

    private final TradeService tradeService;
    private final Random random = new Random();
    private final String[] symbols = {"AAPL", "GOOGL", "MSFT", "AMZN", "TSLA", "BTC-USD"};
    private final ObjectMapper objectMapper;

    @PostConstruct
    public void init() {
        System.out.println("========= MockDataGenerator STARTED =========");
    }

    @Scheduled(fixedRate = 2000)  // упростите до константы
    public void generateData() {
        System.out.println("========= GENERATING DATA =========");
        // ... остальной код
    }
}
```

### 4. Проверьте уровень логирования

Ваши логи — `log.debug(...)`. Если уровень стоит `INFO`, вы их не увидите! Добавьте в `application.yml`:

```yaml
logging:
  level:
    com.websocket.trade: DEBUG
    root: INFO
```

Или замените `log.debug` на `log.info` / `System.out.println` для теста.

### 5. Убедитесь что `@EnableScheduling` работает

```java
@SpringBootApplication
@EnableScheduling  // ← должно быть здесь
public class Application {
```

**Не ставьте `@EnableScheduling` на самом `MockDataGenerator`** — уберите его оттуда, оставьте только на главном классе.

## Итого — чеклист

| # | Проверка | ✓ |
|---|----------|---|
| 1 | `application.yml` лежит в `src/main/resources/` | |
| 2 | YAML использует пробелы, не табы | |
| 3 | Нет другого файла, перекрывающего настройки | |
| 4 | `@EnableScheduling` на главном классе | |
| 5 | `TradeService` успешно создаётся | |
| 6 | Уровень логирования позволяет видеть `DEBUG` | |
| 7 | Без `@ConditionalOnProperty` бин создаётся | |
